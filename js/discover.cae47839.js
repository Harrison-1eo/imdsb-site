"use strict";(self["webpackChunkimvue"]=self["webpackChunkimvue"]||[]).push([[842],{5410:function(e,t,r){r(4114);var a=r(8355),i=r(1219),n=r(5548),s=r(4985);const o=a.A.create({baseURL:s.b,timeout:1e4});o.interceptors.request.use((e=>{if(e.headers.Authorization=`Bearer ${localStorage.getItem("token")}`,!e.url.includes("upload")&&e.data){const t=n.Ln.encrypt(JSON.stringify(e.data));e.data={data:t.cipherText,position:t.position,mac:"",length:0}}return e}),(e=>(console.log("request error",e),Promise.reject(e)))),o.interceptors.response.use((e=>{if(e.data.data){const r=e.data.en_data.data,a=e.data.en_data.position;let s="";try{s=n.VJ.decrypt(r,a)}catch(t){i.nk.error("解密失败，请重新登录获取密钥"),localStorage.clear(),(void 0).$router.push("/login")}e.data.data=JSON.parse(s)}return e}),(e=>(console.log("error",e),401===e.response.status&&(i.nk.error("登录无效或过期，请重新登录"),localStorage.clear(),window.location.href="/login"),Promise.reject(e)))),t.A=o},6917:function(e,t,r){r.r(t),r.d(t,{default:function(){return U}});var a=r(6768),i=r(4232);const n={class:"friend-container"},s={class:"chat-list"},o=(0,a.Lk)("h2",{style:{"padding-left":"20px"}},"终端列表",-1),d={class:"friend-details"};function c(e,t,r,c,l,u){const h=(0,a.g2)("el-menu-item"),m=(0,a.g2)("el-scrollbar"),f=(0,a.g2)("el-menu"),p=(0,a.g2)("FriendChat");return(0,a.uX)(),(0,a.CE)("div",n,[(0,a.Lk)("div",s,[o,(0,a.bF)(f,{class:"el-menu-rooms"},{default:(0,a.k6)((()=>[(0,a.bF)(m,{"wrap-class":"scrollbar-wrapper"},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(l.friends,(e=>((0,a.uX)(),(0,a.Wv)(h,{class:"el-menu-item-button",key:e.ID.toString(),index:e.ID,onClick:t=>u.fetchFriendInfo(e.ID)},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(e.username),1)])),_:2},1032,["index","onClick"])))),128))])),_:1})])),_:1})]),(0,a.Lk)("div",d,[l.activeFriendId?((0,a.uX)(),(0,a.Wv)(p,{key:0,activeFriend:l.activeFriend},null,8,["activeFriend"])):(0,a.Q3)("",!0)])])}var l=r(5410);const u={class:"friend-chat-container"},h={class:"friend-chat-info-container"},m={class:"friend-avatar"},f={class:"friend-username"},p={class:"friend-details"},v={class:"friend-more"},F={class:"friend-chat-list-container"},g=(0,a.Lk)("h2",{style:{"padding-left":"20px",margin:"0 0 10px"}},"共同通讯室",-1);function k(e,t,r,n,s,o){const d=(0,a.g2)("el-avatar"),c=(0,a.g2)("More"),l=(0,a.g2)("el-icon"),k=(0,a.g2)("FriendDrawer"),I=(0,a.g2)("el-divider"),w=(0,a.g2)("el-menu-item"),y=(0,a.g2)("el-scrollbar"),_=(0,a.g2)("el-menu"),b=(0,a.g2)("el-empty");return(0,a.uX)(),(0,a.CE)("div",u,[(0,a.Lk)("div",h,[(0,a.Lk)("div",m,[(0,a.bF)(d,{src:o.avatarUrl(),size:80,class:"user-avatar",shape:"square"},null,8,["src"])]),(0,a.Lk)("div",f,(0,i.v_)(s.userInfo.username||"No username provided"),1),(0,a.Lk)("div",p,[(0,a.Lk)("p",null,"邮箱: "+(0,i.v_)(s.userInfo.email||"No email provided"),1),(0,a.Lk)("p",null,"地区: "+(0,i.v_)(s.userInfo.country||"中国"),1)]),(0,a.Lk)("div",v,[(0,a.bF)(l,{onClick:t[0]||(t[0]=e=>s.drawer=!0),style:{cursor:"pointer"}},{default:(0,a.k6)((()=>[(0,a.bF)(c)])),_:1}),(0,a.bF)(k,{modelValue:s.drawer,"onUpdate:modelValue":t[1]||(t[1]=e=>s.drawer=e),ifFetch:s.ifFetch,"onUpdate:ifFetch":t[2]||(t[2]=e=>s.ifFetch=e),friendID:r.activeFriend.ID,friend:r.activeFriend},null,8,["modelValue","ifFetch","friendID","friend"])])]),(0,a.bF)(I,{style:{margin:"20px 0"}}),(0,a.Lk)("div",F,[s.roomsBetween.length>0?((0,a.uX)(),(0,a.Wv)(_,{key:0,class:"el-menu-rooms friend-chat-list-menu"},{default:(0,a.k6)((()=>[g,(0,a.bF)(y,{"wrap-class":"scrollbar-wrapper"},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(s.roomsBetween,(e=>((0,a.uX)(),(0,a.Wv)(w,{class:"el-menu-item-button",style:{"font-size":"large"},key:e.ID,index:e.ID.toString(),onClick:t=>o.jumpToRoom(e)},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(e.name),1)])),_:2},1032,["index","onClick"])))),128))])),_:1})])),_:1})):((0,a.uX)(),(0,a.Wv)(b,{key:1,description:"暂无共同通讯室"}))])])}r(4114);var I=r(2357),w=r(8165),y=r(1219),_=r(4985);function b(e,t,r,n,s,o){const d=(0,a.g2)("el-button"),c=(0,a.g2)("el-card"),l=(0,a.g2)("el-drawer");return(0,a.uX)(),(0,a.Wv)(l,{"show-close":"",drawe:""},{header:(0,a.k6)((()=>[(0,a.Lk)("h2",null,(0,i.v_)(r.friend.username),1)])),footer:(0,a.k6)((()=>[(0,a.bF)(d,{type:"danger"},{default:(0,a.k6)((()=>[(0,a.eW)("删除终端")])),_:1})])),default:(0,a.k6)((()=>[(0,a.bF)(c,{style:{"max-width":"480px"}},{default:(0,a.k6)((()=>[(0,a.bF)(d,{type:"primary",class:"changedescription",onClick:t[0]||(t[0]=e=>o.createRoomChatWithThisGuyBox(r.friend.ID,r.friend.username))},{default:(0,a.k6)((()=>[(0,a.eW)("创建聊天室")])),_:1})])),_:1})])),_:1})}var D=r(2933),C=r(5968),R={name:"FriendDrawer",props:{friend:{type:Object,required:!0}},data(){return{roomUsers:[]}},watch:{},created(){},computed:{activeRoom(){return C.A.state.activeRoom}},methods:{createRoomChatWithThisGuyBox(e,t){D.s.prompt("请输入新的房间名称","创建与"+t+"的聊天室",{inputValue:"chat with "+t,confirmButtonText:"创建",cancelButtonText:"取消",inputPattern:/\S/,inputErrorMessage:"房间名称不能为空"}).then((({value:r})=>{r?this.createRoomChatWithThisGuy(e,t,r):y.nk.error("房间名称不能为空")})).catch((()=>{y.nk.info("创建")}))},async createRoomChatWithThisGuy(e,t,r){if(e.toString()===localStorage.getItem("userId"))return y.nk.error("不能和自己聊天"),!1;const a="自动创建"+r;try{const e=await l.A.post("/api/room/create",{name:r,description:a});if(0!==e.data.code)return y.nk.error(e.data.msg),!1;this.roomID=e.data.data.ID;await l.A.post("/api/room/add_user",{room_id:e.data.data.ID,user_name:t,role:"member"});this.$store.commit("setActiveRoom",e.data.data),this.$router.push({path:"/im/chat"}),y.nk.success("创建聊天室成功, 跳转到聊天室界面")}catch(i){y.nk.error("创建聊天室失败")}},async fetchRoomUsers(){try{const e=await l.A.get("/api/room/members?room_id="+this.roomID);0===e.data.code?this.roomUsers=e.data.data:y.nk.error(e.data.msg)}catch(e){y.nk.error("获取房间成员列表失败")}},async getHistoryMessages(e,t){try{const r=await l.A.post("/api/message/list",{room_id:this.roomID,last_message_id:e,limit:t});if(0===r.data.data.length)return void y.nk.info("没有更多历史消息了");this.messages=[...r.data.data.reverse(),...this.messages]}catch(r){y.nk.error("Failed to fetch messages:",r)}}}},A=r(1241);const W=(0,A.A)(R,[["render",b]]);var x=W,L={name:"FriendChat",components:{FriendDrawer:x,ElAvatar:I.zv,ElDivider:w.fR},props:{activeFriend:{type:Object,required:!0}},data(){return{roomsBetween:[],userInfo:{},ifFetch:!1,drawer:!1}},watch:{activeFriend(){this.fetchRoomsWithFriend(),this.fetchFriendInfo()},ifFetch(){this.drawer=!1,this.ifFetch=!1}},created(){this.fetchRoomsWithFriend(),this.fetchFriendInfo()},methods:{avatarUrl(){return _.b+this.userInfo.avatar},async fetchRoomsWithFriend(){try{const e=await l.A.get("/api/user/common_rooms",{params:{friend_id:this.activeFriend.ID}});0===e.data.code?this.roomsBetween=e.data.data:y.nk.error("获取聊天室列表失败: ",e.data.msg)}catch(e){y.nk.error("Failed to fetch rooms",e)}},async fetchFriendInfo(){try{const e=await l.A.get("/api/user/info",{params:{user_id:this.activeFriend.ID}});0===e.data.code?this.userInfo=e.data.data:y.nk.error("获取用户信息失败: ",e.data.msg)}catch(e){y.nk.error("Failed to fetch friend information:",e)}},jumpToRoom(e){this.$store.commit("setActiveRoom",e),this.$router.push({path:"/im/chat"})}}};const S=(0,A.A)(L,[["render",k]]);var B=S,X={data(){return{friends:[],activeFriendId:null,drawer:!1,ifFetch:!1,activeFriend:null}},components:{FriendChat:B},watch:{ifFetch(){this.selectNoFriend(),this.drawer=!1,this.ifFetch=!1}},created(){this.fetchFriends()},methods:{selectNoFriend(){this.activeFriend=null,this.activeFriendId=null,this.fetchFriends()},createdRoomBoxwithChosenFriend(){const e="chat with"+this.activeFriend.username;this.$emit("createRoom",e)},async fetchFriends(){try{const e=await l.A.get("/api/user/friends");this.friends=e.data.data,this.friends=this.friends.filter((e=>e.ID.toString()!==localStorage.getItem("userId").toString()))}catch(e){}},fetchFriendInfo(e){this.activeFriendId=e,this.activeFriend=this.friends.find((t=>t.ID===e))}}};const T=(0,A.A)(X,[["render",c]]);var U=T}}]);
//# sourceMappingURL=discover.cae47839.js.map