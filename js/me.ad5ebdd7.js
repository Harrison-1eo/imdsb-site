"use strict";(self["webpackChunkimvue"]=self["webpackChunkimvue"]||[]).push([[693],{5410:function(e,t,o){o(4114);var s=o(8355),a=o(1219),i=o(5548),r=o(4985);const n=s.A.create({baseURL:r.b,timeout:1e4});n.interceptors.request.use((e=>{if(e.headers.Authorization=`Bearer ${localStorage.getItem("token")}`,!e.url.includes("upload")&&e.data){const t=i.Ln.encrypt(JSON.stringify(e.data));e.data={data:t.cipherText,position:t.position,mac:"",length:0}}return e}),(e=>(console.log("request error",e),Promise.reject(e)))),n.interceptors.response.use((e=>{if(e.data.data){const o=e.data.en_data.data,s=e.data.en_data.position;let r="";try{r=i.VJ.decrypt(o,s)}catch(t){a.nk.error("解密失败，请重新登录获取密钥"),localStorage.clear(),(void 0).$router.push("/login")}e.data.data=JSON.parse(r)}return e}),(e=>(console.log("error",e),401===e.response.status&&(a.nk.error("登录无效或过期，请重新登录"),localStorage.clear(),window.location.href="/login"),Promise.reject(e)))),t.A=n},119:function(e,t,o){o.r(t),o.d(t,{default:function(){return st}});var s=o(6768),a=o(4232);const i=e=>((0,s.Qi)("data-v-9bfb1b5a"),e=e(),(0,s.jt)(),e),r={class:"chatroom-container"},n={class:"chat-list"},l=i((()=>(0,s.Lk)("h2",{style:{"padding-left":"20px"}},"通信列表",-1))),c={class:"chat-details"};function d(e,t,o,i,d,m){const h=(0,s.g2)("el-menu-item"),u=(0,s.g2)("el-scrollbar"),p=(0,s.g2)("el-menu"),g=(0,s.g2)("el-button"),f=(0,s.g2)("RoomChat");return(0,s.uX)(),(0,s.CE)("div",r,[(0,s.Lk)("div",n,[l,(0,s.bF)(p,{class:"el-menu-rooms"},{default:(0,s.k6)((()=>[(0,s.bF)(u,{"wrap-class":"scrollbar-wrapper"},{default:(0,s.k6)((()=>[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(d.rooms,(e=>((0,s.uX)(),(0,s.Wv)(h,{"default-active":d.activeRoomId,class:"el-menu-item-button",key:e.ID,index:e.ID,onClick:t=>m.activeOneRoom(e.ID)},{default:(0,s.k6)((()=>[(0,s.eW)((0,a.v_)(e.name),1)])),_:2},1032,["default-active","index","onClick"])))),128))])),_:1})])),_:1}),(0,s.bF)(g,{type:"primary",class:"new-chat-button",onClick:m.createRoomBox},{default:(0,s.k6)((()=>[(0,s.eW)(" 创建新通讯 ")])),_:1},8,["onClick"])]),(0,s.Lk)("div",c,[d.activeRoomId?((0,s.uX)(),(0,s.Wv)(f,{key:0,roomID:d.activeRoomId,ifUpdateRoomList2Chat:d.ifUpdateRoomList2Chat,"onUpdate:ifUpdateRoomList2Chat":t[0]||(t[0]=e=>d.ifUpdateRoomList2Chat=e)},null,8,["roomID","ifUpdateRoomList2Chat"])):(0,s.Q3)("",!0)])])}var m=o(5410);const h={class:"chat-details"},u={class:"chat-header"},p={class:"room-title"},g={class:"chat-box",id:"chat-box"},f={class:"chat-messages",ref:"messageContainer",id:"message-box"},v={ref:"inner",class:"message-inner-list"},k={key:0,class:"video-container",width:"640",height:"500"},b={class:"input-box",id:"input-box"};function y(e,t,o,i,r,n){const l=(0,s.g2)("More"),c=(0,s.g2)("el-icon"),d=(0,s.g2)("RoomDrawer"),m=(0,s.g2)("el-button"),y=(0,s.g2)("MessageItem"),I=(0,s.g2)("el-scrollbar"),w=(0,s.g2)("LiveStream"),C=(0,s.g2)("el-dialog"),_=(0,s.g2)("ChatInput");return(0,s.uX)(),(0,s.CE)("div",h,[(0,s.Lk)("div",u,[(0,s.Lk)("p",p,(0,a.v_)(r.roomInfo.name),1),o.roomID?((0,s.uX)(),(0,s.Wv)(c,{key:0,onClick:t[0]||(t[0]=e=>r.drawer=!0),class:"more-icon"},{default:(0,s.k6)((()=>[(0,s.bF)(l)])),_:1})):(0,s.Q3)("",!0)]),o.roomID?((0,s.uX)(),(0,s.Wv)(d,{key:0,modelValue:r.drawer,"onUpdate:modelValue":t[1]||(t[1]=e=>r.drawer=e),ifUpdate:r.ifUpdate,"onUpdate:ifUpdate":t[2]||(t[2]=e=>r.ifUpdate=e),roomInfo:r.roomInfo,"onUpdate:roomInfo":t[3]||(t[3]=e=>r.roomInfo=e),roomID:o.roomID},null,8,["modelValue","ifUpdate","roomInfo","roomID"])):(0,s.Q3)("",!0),(0,s.Lk)("div",g,[(0,s.Lk)("div",f,[(0,s.bF)(I,{ref:"scrollbar"},{default:(0,s.k6)((()=>[(0,s.Lk)("div",v,[(0,s.bF)(m,{type:"text",link:"",onClick:n.getMoreHistoryMessages,style:{margin:"9px"}},{default:(0,s.k6)((()=>[(0,s.eW)(" 加载更多历史消息 ")])),_:1},8,["onClick"]),((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(r.messages,((e,t)=>((0,s.uX)(),(0,s.Wv)(y,{key:t,message:e,class:"message"},null,8,["message"])))),128))],512)])),_:1},512)],512),(0,s.bF)(C,{modelValue:r.recieveVideoVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>r.recieveVideoVisible=e),title:"视频聊天室",width:"680",height:"480",visible:r.recieveVideoVisible,"onUpdate:visible":t[5]||(t[5]=e=>r.recieveVideoVisible=e),"close-on-click-modal":!1,"close-on-press-escape":!1},{default:(0,s.k6)((()=>[r.recieveVideoVisible?((0,s.uX)(),(0,s.CE)("div",k,[(0,s.bF)(w,{roomID:o.roomID,VideoChunk:r.VideoChunk,onCloseCamera:n.closeCamera,onForceforceDeleteVideoBeTrue:n.ForceforceDeleteVideoBeTrue},null,8,["roomID","VideoChunk","onCloseCamera","onForceforceDeleteVideoBeTrue"])])):(0,s.Q3)("",!0)])),_:1},8,["modelValue","visible"]),(0,s.Lk)("div",b,[(0,s.bF)(_,{ref:"ChatInput",roomID:o.roomID,onSend:n.sendMessageToParent,onForceforceDeleteVideoBeFalse:n.ForceforceDeleteVideoBeFalse},null,8,["roomID","onSend","onForceforceDeleteVideoBeFalse"])])])])}o(4114);const I=e=>((0,s.Qi)("data-v-7eb7e1ca"),e=e(),(0,s.jt)(),e),w={class:"message-content"},C={key:0,class:"sender-name, sender-name-from-other"},_={key:0},F={key:1},V={key:2,class:"file-message-link"},L=I((()=>(0,s.Lk)("div",null,"加密信息",-1))),R=I((()=>(0,s.Lk)("div",{class:"message-encrypt-info"},[(0,s.Lk)("div",{class:"message-encrypt-info-key"},"加密方式： "),(0,s.Lk)("div",{class:"message-encrypt-info-value"},"ZUC-256 加速算法xiao")],-1))),U={class:"message-encrypt-info"},x=I((()=>(0,s.Lk)("div",{class:"message-encrypt-info-key"},"消息长度：",-1))),D={class:"message-encrypt-info-value"},M={class:"message-encrypt-info"},S=I((()=>(0,s.Lk)("div",{class:"message-encrypt-info-key"},"起始位置：",-1))),B={class:"message-encrypt-info-value"},E={class:"message-encrypt-info"},$=I((()=>(0,s.Lk)("div",{class:"message-encrypt-info-key"},"加密密钥：",-1))),T={class:"message-encrypt-info-value"},z={class:"message-encrypt-info"},A=I((()=>(0,s.Lk)("div",{class:"message-encrypt-info-key"},"加密结果（经过Base64编码）：",-1))),X={class:"message-encrypt-info-value"};function N(e,t,o,i,r,n){const l=(0,s.g2)("el-avatar"),c=(0,s.g2)("el-image"),d=(0,s.g2)("Link"),m=(0,s.g2)("el-icon"),h=(0,s.g2)("el-link"),u=(0,s.g2)("More"),p=(0,s.g2)("el-dialog");return(0,s.uX)(),(0,s.CE)(s.FK,null,[(0,s.Lk)("div",{class:(0,a.C4)(["message-item",{"message-from-user":n.isSenderUser}])},[(0,s.bF)(l,{shape:"square",src:n.getAvatarUrl(o.message.sender_avatar),style:{"margin-top":"0px"}},null,8,["src"]),(0,s.Lk)("div",w,[!1===n.isSenderUser?((0,s.uX)(),(0,s.CE)("div",C,(0,a.v_)(o.message.sender_name),1)):(0,s.Q3)("",!0),(0,s.Lk)("div",{onMouseenter:t[1]||(t[1]=e=>r.showMoreButton=!0),onMouseleave:t[2]||(t[2]=e=>r.showMoreButton=!1)},[(0,s.Lk)("div",{class:(0,a.C4)({"bubble-and-more-left":!n.isSenderUser,"bubble-and-more-right":n.isSenderUser})},[(0,s.Lk)("div",{class:(0,a.C4)(["chat-bubble chat-bubble-top",n.isSenderUser?"chat-bubble-from-right":"chat-bubble-from-left"]),style:{"--chat-bubble-background-color":"#ffffff","--chat-bubble-border-color":"rgba(0, 0, 0, 0)","--chat-bubble-text-color":"#000"}},["text"===o.message.type?((0,s.uX)(),(0,s.CE)("div",_,(0,a.v_)(o.message.content),1)):"image"===o.message.type?((0,s.uX)(),(0,s.CE)("div",F,[(0,s.bF)(c,{src:n.getPicUrl(o.message.content),fit:"contain",previewSrcList:[n.getPicUrl(o.message.content)],style:{height:"auto",display:"block"}},null,8,["src","previewSrcList"])])):"file"===o.message.type?((0,s.uX)(),(0,s.CE)("div",V,[(0,s.bF)(m,null,{default:(0,s.k6)((()=>[(0,s.bF)(d)])),_:1}),(0,s.bF)(h,{href:n.getFileUrl(o.message.content),target:"_blank"},{default:(0,s.k6)((()=>[(0,s.eW)(" 下载文件："+(0,a.v_)(this.getFileName(o.message.content)),1)])),_:1},8,["href"])])):(0,s.Q3)("",!0)],2),r.showMoreButton?((0,s.uX)(),(0,s.Wv)(m,{key:0,style:{margin:"5px 10px",cursor:"pointer"},onClick:t[0]||(t[0]=e=>r.showDialog=!0)},{default:(0,s.k6)((()=>[(0,s.bF)(u)])),_:1})):(0,s.Q3)("",!0)],2)],32)])],2),(0,s.bF)(p,{modelValue:r.showDialog,"onUpdate:modelValue":t[3]||(t[3]=e=>r.showDialog=e),title:"加密信息",width:"800"},{header:(0,s.k6)((()=>[L])),default:(0,s.k6)((()=>[R,(0,s.Lk)("div",U,[x,(0,s.Lk)("div",D,(0,a.v_)(o.message.encryptInfo.length),1)]),(0,s.Lk)("div",M,[S,(0,s.Lk)("div",B,(0,a.v_)(o.message.encryptInfo.position),1)]),(0,s.Lk)("div",E,[$,(0,s.Lk)("div",T,(0,a.v_)(o.message.encryptInfo.key),1)]),(0,s.Lk)("div",z,[A,(0,s.Lk)("div",X,(0,a.v_)(o.message.encryptInfo.data),1)])])),_:1},8,["modelValue"])],64)}var q=o(2357),H=o(7009),W=o(2557),P=(0,s.pM)({name:"Link"});const j={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},O=(0,s.bF)("path",{fill:"currentColor",d:"M715.648 625.152 670.4 579.904l90.496-90.56c75.008-74.944 85.12-186.368 22.656-248.896-62.528-62.464-173.952-52.352-248.96 22.656L444.16 353.6l-45.248-45.248 90.496-90.496c100.032-99.968 251.968-110.08 339.456-22.656 87.488 87.488 77.312 239.424-22.656 339.456l-90.496 90.496zm-90.496 90.496-90.496 90.496C434.624 906.112 282.688 916.224 195.2 828.8c-87.488-87.488-77.312-239.424 22.656-339.456l90.496-90.496 45.248 45.248-90.496 90.56c-75.008 74.944-85.12 186.368-22.656 248.896 62.528 62.464 173.952 52.352 248.96-22.656l90.496-90.496 45.248 45.248zm0-362.048 45.248 45.248L398.848 670.4 353.6 625.152 625.152 353.6z"},null,-1);function Q(e,t,o,a,i,r){return(0,s.uX)(),(0,s.Wv)("svg",j,[O])}P.render=Q,P.__file="packages/components/Link.vue";var J=P,K=o(4985),Y={data(){return{showMoreButton:!1,showDialog:!1}},components:{Link:J,ElAvatar:q.zv,ElImage:H.Zq,ElLink:W.C4},props:{message:{type:Object,required:!0}},computed:{isSenderUser(){const e=localStorage.getItem("userId");return e&&parseInt(e,10)===this.message.sender_id}},methods:{getFileUrl(e){const t=/you can download the file on (\/static\/files\/\S+)/,o=e.match(t);return o?K.b+o[1]:""},getFileName(e){const t=/(.+) you can download the file on \/\S+/g;return e.replace(t,"$1")},getAvatarUrl(e){return e&&"string"===typeof e?K.b+e:"https://zos.alipayobjects.com/rmsportal/ODTLcjxAfvqbxHnVXCYX.png"},getPicUrl(e){return e?K.b+e:K.b+"/static/avatars/nopic.png"}}},Z=o(1241);const G=(0,Z.A)(Y,[["render",N],["__scopeId","data-v-7eb7e1ca"]]);var ee=G,te=o(5130);const oe={class:"chat-input"},se={class:"chat-input-icon-box"},ae={class:"upload-icon"},ie={class:"upload-icon"},re={class:"upload-icon"},ne={key:0,class:"video-container"},le={ref:"video",id:"video",width:"640",height:"480",autoplay:""},ce={class:"chat-input-input-box"},de={class:"chat-input-send-box"};function me(e,t,o,a,i,r){const n=(0,s.g2)("Picture"),l=(0,s.g2)("el-icon"),c=(0,s.g2)("el-tooltip"),d=(0,s.g2)("FolderAdd"),m=(0,s.g2)("VideoCamera"),h=(0,s.g2)("el-button"),u=(0,s.g2)("el-dialog"),p=(0,s.g2)("el-divider"),g=(0,s.g2)("Promotion");return(0,s.uX)(),(0,s.CE)("div",oe,[(0,s.Lk)("div",se,[(0,s.Lk)("div",ae,[(0,s.bF)(c,{class:"box-item",effect:"dark",content:"发送图片",placement:"top"},{default:(0,s.k6)((()=>[(0,s.bF)(l,{size:"20px",onClick:r.openImageChooser},{default:(0,s.k6)((()=>[(0,s.bF)(n)])),_:1},8,["onClick"])])),_:1}),(0,s.Lk)("input",{type:"file",ref:"imageInput",style:{display:"none"},accept:"image/*",onChange:t[0]||(t[0]=(...e)=>r.handleImageUpload&&r.handleImageUpload(...e))},null,544)]),(0,s.Lk)("div",ie,[(0,s.bF)(c,{class:"box-item",effect:"dark",content:"发送文件",placement:"top"},{default:(0,s.k6)((()=>[(0,s.bF)(l,{size:"20px",onClick:r.openFileChooser},{default:(0,s.k6)((()=>[(0,s.bF)(d)])),_:1},8,["onClick"])])),_:1}),(0,s.Lk)("input",{type:"file",ref:"fileInput",style:{display:"none"},onChange:t[1]||(t[1]=(...e)=>r.handleFileUpload&&r.handleFileUpload(...e))},null,544)]),(0,s.Lk)("div",re,[(0,s.bF)(c,{content:"打开摄像头",placement:"top"},{default:(0,s.k6)((()=>[(0,s.bF)(l,{size:"20px",onClick:r.openCameraandVideoChat},{default:(0,s.k6)((()=>[(0,s.bF)(m)])),_:1},8,["onClick"])])),_:1}),i.videocontainerVisible?((0,s.uX)(),(0,s.CE)("div",ne,[(0,s.bF)(u,{modelValue:i.videoVisible,"onUpdate:modelValue":t[2]||(t[2]=e=>i.videoVisible=e),title:"视频聊天",width:"660",height:"480",visible:i.videoVisible,"onUpdate:visible":t[3]||(t[3]=e=>i.videoVisible=e),"close-on-click-modal":!1,"close-on-press-escape":!1},{default:(0,s.k6)((()=>[(0,s.Lk)("video",le,null,512),(0,s.bF)(h,{onClick:r.startSendingVideo},{default:(0,s.k6)((()=>[(0,s.eW)("连接")])),_:1},8,["onClick"]),(0,s.bF)(h,{class:"close-button",onClick:r.closeCamera},{default:(0,s.k6)((()=>[(0,s.eW)("关闭摄像头")])),_:1},8,["onClick"])])),_:1},8,["modelValue","visible"])])):(0,s.Q3)("",!0)])]),(0,s.bF)(p,{style:{margin:"0 5px"}}),(0,s.Lk)("div",ce,[(0,s.bo)((0,s.Lk)("textarea",{rows:"3","onUpdate:modelValue":t[4]||(t[4]=e=>i.newMessage=e),placeholder:"输入消息...",class:"message-input",onKeyup:t[5]||(t[5]=(0,te.jR)((e=>r.sendMessage()),["enter"]))},null,544),[[te.Jo,i.newMessage]])]),(0,s.Lk)("div",de,[(0,s.bF)(h,{type:"success",class:"send-button",onClick:t[6]||(t[6]=e=>r.sendMessage())},{default:(0,s.k6)((()=>[(0,s.bF)(l,{size:"20px"},{default:(0,s.k6)((()=>[(0,s.bF)(g)])),_:1})])),_:1})])])}var he=o(1219),ue=(0,s.pM)({name:"Picture"});const pe={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},ge=(0,s.bF)("path",{fill:"currentColor",d:"M160 160v704h704V160H160zm-32-64h768a32 32 0 0 1 32 32v768a32 32 0 0 1-32 32H128a32 32 0 0 1-32-32V128a32 32 0 0 1 32-32z"},null,-1),fe=(0,s.bF)("path",{fill:"currentColor",d:"M384 288q64 0 64 64t-64 64q-64 0-64-64t64-64zM185.408 876.992l-50.816-38.912L350.72 556.032a96 96 0 0 1 134.592-17.856l1.856 1.472 122.88 99.136a32 32 0 0 0 44.992-4.864l216-269.888 49.92 39.936-215.808 269.824-.256.32a96 96 0 0 1-135.04 14.464l-122.88-99.072-.64-.512a32 32 0 0 0-44.8 5.952L185.408 876.992z"},null,-1);function ve(e,t,o,a,i,r){return(0,s.uX)(),(0,s.Wv)("svg",pe,[ge,fe])}ue.render=ve,ue.__file="packages/components/Picture.vue";var ke=ue,be=(0,s.pM)({name:"FolderAdd"});const ye={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},Ie=(0,s.bF)("path",{fill:"currentColor",d:"M128 192v640h768V320H485.76L357.504 192H128zm-32-64h287.872l128.384 128H928a32 32 0 0 1 32 32v576a32 32 0 0 1-32 32H96a32 32 0 0 1-32-32V160a32 32 0 0 1 32-32zm384 416V416h64v128h128v64H544v128h-64V608H352v-64h128z"},null,-1);function we(e,t,o,a,i,r){return(0,s.uX)(),(0,s.Wv)("svg",ye,[Ie])}be.render=we,be.__file="packages/components/FolderAdd.vue";var Ce=be,_e=(0,s.pM)({name:"VideoCamera"});const Fe={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 1024 1024"},Ve=(0,s.bF)("path",{fill:"currentColor",d:"M704 768V256H128v512h576zm64-416 192-96v512l-192-96v128a32 32 0 0 1-32 32H96a32 32 0 0 1-32-32V224a32 32 0 0 1 32-32h640a32 32 0 0 1 32 32v128zm0 71.552v176.896l128 64V359.552l-128 64zM192 320h192v64H192v-64z"},null,-1);function Le(e,t,o,a,i,r){return(0,s.uX)(),(0,s.Wv)("svg",Fe,[Ve])}_e.render=Le,_e.__file="packages/components/VideoCamera.vue";var Re=_e,Ue=o(7477),xe={components:{Picture:ke,FolderAdd:Ce,VideoCamera:Re,Bottom:Ue.Bottom},props:{roomID:{type:Number,required:!0}},data(){return{newMessage:"",roomId:this.roomID,videoVisible:!1,videoVisible2:!1,videocontainerVisible:!1,stream:null,isRecording:!1,mediaRecorder:null,chunks:[],video:null}},methods:{async openCameraandVideoChat(){this.videoVisible=!0,this.videocontainerVisible=!0,this.$nextTick((async()=>{try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0}),this.$emit("ForceforceDeleteVideoBeFalse"),this.video=this.$refs.video,this.video.srcObject=this.stream}catch(e){he.nk.error("Error accessing camera:",e)}}))},closeCamera(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=null),this.video&&(this.video.srcObject=null),this.ws&&this.ws.readyState===WebSocket.OPEN&&this.ws.close(),clearInterval(this.frameInterval),this.videoVisible=!1,this.videocontainerVisible=!1,this.stopRecording()},startSendingVideo(){this.isRecording=!0,this.videoVisible=!1;const e=document.createElement("canvas"),t=e.getContext("2d");e.width=640,e.height=480;const o=()=>{if(!this.isRecording)return;if(this.video.paused||this.video.ended)return;t.drawImage(this.video,0,0,e.width,e.height);const s=e.toDataURL("image/jpeg",.5);this.$emit("send","video",s),requestAnimationFrame(o)};o()},reopenCamera(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=null),this.$nextTick((async()=>{try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0}),this.video.srcObject=this.stream}catch(e){he.nk.error("Error accessing camera:",e)}}))},stopRecording(){this.mediaRecorder&&this.isRecording&&(this.isRecording=!1,this.mediaRecorder.stop(),this.chunks=[])},sendMessage(){this.newMessage=this.newMessage.trim(),this.newMessage?(this.$emit("send","text",this.newMessage),this.newMessage=""):he.nk.warning("消息不能为空")},openFileChooser(){this.$refs.fileInput.click()},openImageChooser(){this.$refs.imageInput.click()},handleImageUpload(e){const t=e.target.files[0];t&&this.uploadFile(t,"image")},handleFileUpload(e){const t=e.target.files[0];t&&this.uploadFile(t,"file")},async uploadFile(e,t){try{const o=new FormData;o.append("room_id",this.roomId),o.append("file",e);const s=await m.A.post("/api/message/upload",o,{headers:{"Content-Type":"multipart/form-data"}});if(0===s.data.code){this.roomId,s.data.data.file_name;if("file"===t)this.$emit("send","file",s.data.data.file_name+" you can download the file on "+s.data.data.file_url);else{if("image"!==t)throw new Error("上传文件失败，无效的文件类型");this.$emit("send","image",s.data.data.file_url)}return s.data.data}throw new Error(s.data.msg||"上传文件失败")}catch(o){he.nk.error("Failed to upload file:",o)}}}};const De=(0,Z.A)(xe,[["render",me],["__scopeId","data-v-76f2652b"]]);var Me=De,Se=o(5548);class Be{constructor(e,t,o,s=!1){this.url=e+"?token=Bearer "+t,this.token=t,this.callback=o,this.ws=null,this.status=0,this.ping=1e4,this.pingInterval=null,this.reconnect=5e3,this.ifENCRYPT=s,this.textDecoder=new TextDecoder("utf-8")}connect(){this.ws=new WebSocket(this.url),this.ws.onopen=()=>{this.status=1,this.heartHandler()},this.ws.onmessage=e=>{if(this.ifENCRYPT){let t=JSON.parse(e.data);if(0===t.code)try{t.data.content=Se.Uf.decrypt(t.en_data.data,t.en_data.position)}catch(e){he.nk.error("解密失败，请重新登录获取密钥")}this.callback(t)}else this.callback(JSON.parse(e.data))},this.ws.onerror=e=>{},this.ws.onclose=e=>{this.onClose(e)}}send(e){const t=Se.uw.encrypt(e.content);return e.content="",e.en_data={data:t.cipherText,position:t.position,mac:"",length:0},this.ws.send(JSON.stringify(e))}close(){this.status=2,this.ws.close(),clearInterval(this.pingInterval)}onClose(e){2!==this.status&&(console.error(e),this.status=2===this.status?this.status:0,setTimeout((()=>{0===this.status&&this.connect()}),this.reconnect))}heartHandler(){const e={room_id:0,type:"ping",data:""};this.pingInterval=setInterval((()=>{1===this.status?this.ws.send(JSON.stringify(e)):clearInterval(this.pingInterval)}),this.ping)}}const Ee={class:"video-container",width:"640",height:"480"},$e={ref:"canvasPlayer",class:"canvas-player",width:"640",height:"480"};function Te(e,t,o,a,i,r){return(0,s.uX)(),(0,s.CE)("div",Ee,[(0,s.Lk)("canvas",$e,null,512),(0,s.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>r.StopLive&&r.StopLive(...e))},"关闭")])}var ze={name:"LiveStream",props:{roomID:{type:Number,required:!0},VideoChunk:{type:String,required:!0}},mounted(){this.initializeLiveStreaming()},data(){return{isInitialized:!1,canvasElement:null,mediaSource:null,sourceBuffer:null,queue:[]}},watch:{VideoChunk:{deep:!0,handler(e,t){this.isInitialized||this.initializeLiveStreaming(),this.handleReceivedVideoChunk_Base64(e)}},"queue.length"(e){e>0&&this.isInitialized&&this.processQueue()}},methods:{initializeLiveStreaming(){this.canvasElement=this.$refs.canvasPlayer,this.canvasElement?this.isInitialized=!0:ElMessage.error("Video element is not initialized.")},handleReceivedVideoChunk_Base64(e){this.queue.push(e)},processQueue(){try{while(this.queue.length>0){const e=this.queue.shift(),t=new Image;t.src=e,t.onload=()=>{const e=this.canvasElement,o=e.getContext("2d");o.drawImage(t,0,0,e.width,e.height)}}}catch(e){ElMessage.error("Error processing queue:",e)}},StopLive(){this.$emit("closeCamera"),this.queue=[],this.canvasElement=null,this.isInitialized=!1,this.$el.remove(),this.$emit("ForceforceDeleteVideoBeTrue")}}};const Ae=(0,Z.A)(ze,[["render",Te],["__scopeId","data-v-256c256c"]]);var Xe=Ae;const Ne=e=>((0,s.Qi)("data-v-3335d8b1"),e=e(),(0,s.jt)(),e),qe={class:"room-drawer-header"},He=Ne((()=>(0,s.Lk)("div",{class:"card-description"},[(0,s.Lk)("span",null,"房间描述")],-1))),We=Ne((()=>(0,s.Lk)("p",null,null,-1))),Pe=Ne((()=>(0,s.Lk)("div",{class:"card-header"},[(0,s.Lk)("span",null,"房间成员")],-1))),je={style:{margin:"auto auto auto 10px"}};function Oe(e,t,o,i,r,n){const l=(0,s.g2)("Edit"),c=(0,s.g2)("el-icon"),d=(0,s.g2)("el-button"),m=(0,s.g2)("el-card"),h=(0,s.g2)("el-avatar"),u=(0,s.g2)("el-col"),p=(0,s.g2)("el-row"),g=(0,s.g2)("el-drawer");return(0,s.uX)(),(0,s.Wv)(g,{"show-close":"",drawer:"",size:"450px"},{header:(0,s.k6)((()=>[(0,s.Lk)("div",qe,[(0,s.Lk)("h2",null,(0,a.v_)(o.roomInfo.name),1),(0,s.bF)(c,{style:{margin:"20px",cursor:"pointer"},onClick:n.updateRoomNameBox},{default:(0,s.k6)((()=>[(0,s.bF)(l)])),_:1},8,["onClick"])])])),footer:(0,s.k6)((()=>[(0,s.bF)(d,{type:"danger",onClick:n.deleteRoom},{default:(0,s.k6)((()=>[(0,s.eW)("退出房间")])),_:1},8,["onClick"])])),default:(0,s.k6)((()=>[(0,s.bF)(m,{style:{"max-width":"480px"}},{header:(0,s.k6)((()=>[He])),footer:(0,s.k6)((()=>[(0,s.bF)(d,{type:"primary",class:"changedescription",onClick:n.updateRoomInfoBox},{default:(0,s.k6)((()=>[(0,s.eW)("修改房间信息")])),_:1},8,["onClick"])])),default:(0,s.k6)((()=>[(0,s.Lk)("p",null,(0,a.v_)(o.roomInfo.description),1)])),_:1}),We,(0,s.bF)(m,{style:{"max-width":"480px"}},{header:(0,s.k6)((()=>[Pe])),footer:(0,s.k6)((()=>[(0,s.bF)(d,{type:"primary",onClick:n.addUserBox},{default:(0,s.k6)((()=>[(0,s.eW)("邀请成员")])),_:1},8,["onClick"])])),default:(0,s.k6)((()=>[(0,s.bF)(p,null,{default:(0,s.k6)((()=>[((0,s.uX)(!0),(0,s.CE)(s.FK,null,(0,s.pI)(r.roomUsers,(e=>((0,s.uX)(),(0,s.Wv)(u,{key:e.id,span:12,style:{display:"flex","text-align":"center",margin:"10px 0"}},{default:(0,s.k6)((()=>[(0,s.bF)(h,{src:n.avatarUrl(e.avatar),size:40},null,8,["src"]),(0,s.Lk)("span",je,(0,a.v_)(e.username),1)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})}var Qe=o(2933),Je={name:"RoomDrawer",props:{roomID:{type:Number,required:!0},roomInfo:{type:Object,required:!0}},data(){return{roomUsers:[]}},watch:{roomID(){this.fetchRoomUsers()}},created(){this.fetchRoomUsers()},methods:{updateRoomNameBox(){Qe.s.prompt("请输入新的房间名称","修改房间名称",{inputValue:this.roomInfo.name,confirmButtonText:"修改",cancelButtonText:"取消",inputPattern:/\S/,inputErrorMessage:"房间名称不能为空"}).then((({value:e})=>{if(!e)return void he.nk.error("房间名称不能为空");const t=this.roomInfo;t.name=e,this.updateRoomInfo(t)})).catch((()=>{he.nk.info("取消修改")}))},updateRoomInfoBox(){Qe.s.prompt("请输入新的房间描述","修改房间信息",{inputValue:this.roomInfo.description,confirmButtonText:"修改",cancelButtonText:"取消",inputType:"textarea",inputPattern:/\S/,inputErrorMessage:"房间描述不能为空"}).then((({value:e})=>{if(!e)return void he.nk.error("房间描述不能为空");const t=this.roomInfo;t.description=e,this.updateRoomInfo(t)})).catch((()=>{he.nk.info("取消修改")}))},addUserBox(){Qe.s.prompt("请输入邀请的用户名称","邀请朋友",{confirmButtonText:"邀请",cancelButtonText:"取消",inputType:"textarea",inputErrorMessage:"用户名称不能为空"}).then((({value:e})=>{e?this.addUser(e):he.nk.error("用户名称不能为空")})).catch((()=>{he.nk.info("取消邀请")}))},async updateRoomInfo(e){try{const t=await m.A.post("/api/room/update",{room_id:this.roomID,name:e.name,description:e.description});if(0!==t.data.code)return he.nk.error(t.data.msg),!1;he.nk.success("修改成功"),this.$emit("update:roomInfo",e),this.$emit("update:ifUpdate",!0)}catch(t){return he.nk.error("Failed to update room info:",t),!1}return!0},async addUser(e){try{const t=await m.A.post("/api/room/add_user",{room_id:this.roomID,user_name:e,role:"member"});if(0!==t.data.code)return he.nk.error(t.data.msg),!1;await this.fetchRoomUsers()}catch(t){return he.nk.error("服务器错误"),!1}return he.nk.success("邀请成功"),!0},async deleteRoom(){try{const e=await m.A.delete("/api/room/delete?room_id="+this.roomID);if(0!==e.data.code)return he.nk.error(e.data.msg),!1;this.$emit("update:ifUpdate",!0),he.nk.success("退出房间成功")}catch(e){return!1}},async fetchRoomUsers(){try{const e=await m.A.get("/api/room/members?room_id="+this.roomID);0===e.data.code?this.roomUsers=e.data.data:he.nk.error(e.data.msg)}catch(e){he.nk.error("获取房间成员列表失败")}},avatarUrl(e){return e?K.b+e:K.b+"/static/avatars/nopic.png"}}};const Ke=(0,Z.A)(Je,[["render",Oe],["__scopeId","data-v-3335d8b1"]]);var Ye=Ke,Ze={name:"RoomChat",props:{roomID:{type:Number,required:!0},ifUpdateRoomList2Chat:{type:Boolean}},components:{RoomDrawer:Ye,MessageItem:ee,ChatInput:Me,LiveStream:Xe},data(){return{roomInfo:{},messages:[],newMessage:"",ws:new Be(K.$,localStorage.getItem("token"),this.addNewMessage,!0),drawer:!1,ifUpdate:!1,currentUser:null,mediaSource:new MediaSource,sourceBuffer:[],recieveVideoVisible:!1,VideoChunks:[],VideoChunk:null,videoElement:null,videoDuration:0,ffmpeg:null,videoTime:10,forceDeleteVideo:!1}},created(){this.getHistoryMessages(0,10),this.fetchRoomInfo(),this.ws.connect();const e=localStorage.getItem("userId"),t=localStorage.getItem("user");e&&t?this.currentUser={user_id:JSON.parse(e),username:JSON.parse(t),avatar:"../../../assets/avatar/dick1.jpg"}:this.$router.push("/login")},watch:{roomID(){this.messages=[],this.getHistoryMessages(0,10),this.fetchRoomInfo()},messages:{deep:!0,handler(){this.handleNewMessage()}},ifUpdate(){this.ifUpdate&&(this.$emit("update:ifUpdateRoomList2Chat",!0),this.ifUpdate=!1)}},mounted(){this.scrollToBottom()},beforeUnmount(){this.ws.close()},methods:{fetchRoomInfo(){m.A.get(`/api/room/info?room_id=${this.roomID}`).then((e=>{0===e.data.code?this.roomInfo=e.data.data:he.nk.error("获取房间信息失败:",e.data.msg)})).catch((e=>{he.nk.error("获取房间信息失败:",e)}))},addNewMessage(e){if(0===e.code){if(e.data.room_id!==this.roomID)return;e.data.encryptInfo=e.en_data,e.data.encryptInfo.key=localStorage.getItem("websocketBackendPassword"),"video"===e.data.type?!1===this.forceDeleteVideo&&(this.recieveVideoVisible=!0,this.ReceiveVideoChunk_Base64(e.data.content)):this.messages.push(e.data)}else 1===e.code?he.nk.error("收到错误消息:",e.msg):2===e.code||he.nk.error("收到未知消息:",e)},sendMessageToParent(e,t){this.ws.send({room_id:this.roomID,type:e,content:t})},ReceiveVideoChunk_Base64(e){this.VideoChunks.push(e),this.VideoChunk=e},async getHistoryMessages(e,t){try{const o=await m.A.post("/api/message/list",{room_id:this.roomID,last_message_id:e,limit:t});if(0===o.data.data.length)return void he.nk.info("没有更多历史消息了");o.data.data.forEach((e=>{e.encryptInfo=o.data.en_data,e.encryptInfo.key=localStorage.getItem("backendPassword")})),this.messages=[...o.data.data.reverse(),...this.messages]}catch(o){he.nk.error("Failed to fetch messages:",o)}},getMoreHistoryMessages(){if(0===this.messages.length)return void he.nk.info("没有更多历史消息了");if(this.messages[this.messages.length-1].ID<=1)return void he.nk.info("没有更多历史消息了");const e=Math.min(...this.messages.map((e=>e.ID)));this.getHistoryMessages(e,10)},scrollToBottom(){this.$nextTick((()=>{const e=this.$refs.scrollbar.$el.querySelector(".el-scrollbar__wrap");e.scrollTop=e.scrollHeight})),this.$refs.scrollbar.handleScroll({direction:"bottom",target:this.$refs.scrollbar.$el.querySelector(".el-scrollbar__wrap")})},isAtBottom(){const e=this.$refs.scrollbar.$el.querySelector(".el-scrollbar__wrap");return e.scrollTop+e.clientHeight+10>=e.scrollHeight},handleNewMessage(){this.isAtBottom()&&this.scrollToBottom()},closeCamera(){this.$refs.ChatInput.closeCamera(),this.recieveVideoVisible=!1},ForceforceDeleteVideoBeFalse(){this.forceDeleteVideo=!1},ForceforceDeleteVideoBeTrue(){this.forceDeleteVideo=!0}}};const Ge=(0,Z.A)(Ze,[["render",y],["__scopeId","data-v-67230354"]]);var et=Ge,tt={data(){return{rooms:[],activeRoom:null,activeRoomId:null,ifUpdateRoomList2Chat:!1}},components:{RoomChat:et},watch:{ifFetch(){this.selectNoRoom(),this.drawer=!1,this.ifFetch=!1},activeRoom(e,t){this.activeRoom=e},ifUpdateRoomList2Chat(){this.fetchRooms()}},created(){this.fetchRooms()},beforeMount(){this.jumpFromFriendChat()},methods:{jumpFromFriendChat(){const e=this.$store.getters.getActiveRoom;console.log("jumpFromFriendChat:",e),e?(this.activeRoomId=e.ID,this.ifUpdateRoomList2Chat=!0,this.$store.commit("clearActiveRoom")):this.selectNoRoom()},selectNoRoom(){this.activeRoom=null,this.activeRoomId=null,this.fetchRooms()},createRoomBox(){Qe.s.prompt("请输入通讯名称","创建新通讯").then((({value:e})=>{e?this.createRoom(e)?he.nk.success("创建成功"):he.nk.error("创建失败"):he.nk.error("通讯名称不能为空")})).catch((()=>{he.nk.info("取消创建")}))},async createRoom(e){try{const t=await m.A.post("/api/room/create",{name:e,description:""});if(0!==t.data.code)return!1;await this.fetchRooms()}catch(t){return!1}return!0},async fetchRooms(){try{const e=await m.A.get("/api/room/list");this.rooms=e.data.data,this.ifUpdateRoomList2Chat&&(this.ifUpdateRoomList2Chat=!1,this.rooms.find((e=>e.ID===this.activeRoomId))?this.activeOneRoom(this.activeRoomId):(this.activeRoom=null,this.activeRoomId=null))}catch(e){he.nk.error("Failed to fetch rooms:",e)}},async activeOneRoom(e){this.activeRoom=this.rooms.find((t=>t.ID===e)),this.activeRoomId=e}}};const ot=(0,Z.A)(tt,[["render",d],["__scopeId","data-v-9bfb1b5a"]]);var st=ot}}]);
//# sourceMappingURL=me.ad5ebdd7.js.map